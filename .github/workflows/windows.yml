name: Build (Windows)

on: [push, workflow_dispatch]

jobs:
  build-windows:
    runs-on: windows-2022

    defaults:
      run:
        shell: cmd

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        submodules: recursive
        ref: master
        fetch-depth: 0

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup Ninja
      run: pip install ninja

    - name: Configure
      run: cmake -S . -B build -G Ninja -D CMAKE_BUILD_TYPE=Release -D BUILD_SHARED_LIBS=OFF -LA
        -D ENABLE_LTO=ON -D ENABLE_FASTER_BUILD=ON -D VERBOSE_BUILD=ON -D TREAT_WARNING_AS_ERROR=OFF
        -D THREADING=TBB -D ENABLE_INTEL_CPU=ON
        -D ENABLE_CLDNN=OFF -D ENABLE_INTEL_GPU=OFF -D ENABLE_ONEDNN_FOR_GPU=OFF -D OPENCL_ICD_LOADER_DISABLE_OPENCLON12=ON
        -D ENABLE_INTEL_GNA=OFF -D ENABLE_INTEL_MYRIAD_COMMON=OFF -D ENABLE_INTEL_MYRIAD=OFF
        -D ENABLE_MULTI=ON -D ENABLE_AUTO=ON -D ENABLE_AUTO_BATCH=ON -D ENABLE_HETERO=ON -D ENABLE_TEMPLATE=OFF
        -D ENABLE_OV_ONNX_FRONTEND=ON -D ENABLE_OV_TF_FRONTEND=ON -D ENABLE_OV_PADDLE_FRONTEND=OFF
        -D ENABLE_DOCS=OFF -D ENABLE_TESTS=OFF -D ENABLE_SAMPLES=OFF
        -D ENABLE_PYTHON=OFF -D ENABLE_WHEEL=OFF
        -D ENABLE_OPENCV=OFF -D ENABLE_GAPI_PREPROCESSING=OFF
        -D ENABLE_REQUIREMENTS_INSTALL=OFF -D ENABLE_CPPLINT=OFF -D ENABLE_CLANG_FORMAT=OFF -D ENABLE_NCC_STYLE=OFF
        -D CMAKE_TOOLCHAIN_FILE=cmake/toolchains/mt.runtime.win32.toolchain.cmake

    - name: Build
      run: cmake --build build --verbose

    - name: Install
      shell: bash
      run: |
        cmake --install build --prefix openvino
        mkdir openvino/include
        cp -R -v thirdparty/onnx/onnx/onnx openvino/include
        cp -R -v build/thirdparty/onnx/onnx/onnx openvino/include
        cp -R -v thirdparty/protobuf/protobuf/src/* openvino/include

    - name: Show
      run: ls -R openvino

    - name: Package
      shell: pwsh
      run: Compress-Archive openvino -DestinationPath openvino-cpu-win64.zip

    - name: Get description
      shell: bash
      run: echo OV_VERSION=`git describe --tags --long` >> $GITHUB_ENV

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: openvino-cpu-win64.zip
        name: Build ${{ env.OV_VERSION }}
        tag_name: ${{ env.OV_VERSION }}
        prerelease: true
